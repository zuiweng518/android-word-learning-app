# GitHub Actions构建失败修复指南

## 问题分析

GitHub Actions构建失败的主要原因：

### 1. Gradle Wrapper文件缺失
- **问题**：`.gitignore`文件中忽略了`.gradle`目录，导致Gradle Wrapper文件不被提交到GitHub
- **影响**：GitHub Actions无法找到`gradle/wrapper/gradle-wrapper.jar`文件
- **解决**：修改`.gitignore`为`.gradle/`（只忽略目录内容，不忽略目录本身）

### 2. GitHub Actions工作流文件缺失
- **问题**：`.github/workflows/`目录存在但为空
- **影响**：GitHub Actions无法找到构建配置文件
- **解决**：需要手动创建`build-apk.yml`文件

## 修复步骤

### 步骤1：修复.gitignore文件

**修改前：**
```gitignore
.gradle
```

**修改后：**
```gitignore
.gradle/
```

**说明**：将`.gradle`改为`.gradle/`，这样会忽略`.gradle`目录内的文件，但不会忽略目录本身。

### 步骤2：生成Gradle Wrapper文件

在项目根目录执行以下命令：

```bash
gradle wrapper --gradle-version 8.2
```

这会生成以下文件：
- `gradle/wrapper/gradle-wrapper.jar`
- `gradle/wrapper/gradle-wrapper.properties`
- `gradlew`
- `gradlew.bat`

### 步骤3：创建GitHub Actions工作流文件

在`.github/workflows/`目录下创建`build-apk.yml`文件：

```yaml
name: Build APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Setup Gradle
      run: |
        if [ ! -f gradle/wrapper/gradle-wrapper.jar ]; then
          echo "Setting up Gradle wrapper..."
          mkdir -p gradle/wrapper
          curl -L https://services.gradle.org/distributions/gradle-8.2-bin.zip -o gradle.zip
          unzip -q gradle.zip
          cp gradle-8.2/lib/gradle-wrapper.jar gradle/wrapper/
          rm -rf gradle.zip gradle-8.2
        fi

    - name: Build Debug APK
      run: ./gradlew assembleDebug --stacktrace

    - name: Build Release APK
      run: ./gradlew assembleRelease --stacktrace

    - name: Upload Debug APK
      uses: actions/upload-artifact@v3
      if: success()
      with:
        name: app-debug
        path: app/build/outputs/apk/debug/app-debug.apk

    - name: Upload Release APK
      uses: actions/upload-artifact@v3
      if: success()
      with:
        name: app-release
        path: app/build/outputs/apk/release/app-release-unsigned.apk

    - name: Upload build logs
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: build-logs
        path: |
          app/build/reports/
          app/build/outputs/logs/
```

### 步骤4：提交并推送修复

```bash
# 添加所有修改的文件
git add .

# 提交修改
git commit -m "Fix GitHub Actions build configuration"

# 推送到GitHub
git push origin master
```

## 验证修复

### 1. 检查文件是否正确提交

访问GitHub仓库，确认以下文件存在：
- `.github/workflows/build-apk.yml`
- `gradle/wrapper/gradle-wrapper.jar`
- `gradle/wrapper/gradle-wrapper.properties`
- `gradlew`
- `gradlew.bat`

### 2. 查看GitHub Actions状态

1. 访问仓库的Actions页面
2. 查看最新的构建记录
3. 确认构建状态为"成功"

### 3. 下载APK文件

如果构建成功，可以下载APK文件：
- `app-debug.apk`
- `app-release-unsigned.apk`

## 常见问题

### 1. Gradle Wrapper文件仍然缺失

**解决方案**：手动下载Gradle Wrapper文件

```bash
# 创建目录
mkdir -p gradle/wrapper

# 下载gradle-wrapper.jar
curl -L https://raw.githubusercontent.com/gradle/gradle/v8.2.0/gradle/wrapper/gradle-wrapper.jar -o gradle/wrapper/gradle-wrapper.jar

# 下载gradle-wrapper.properties
curl -L https://raw.githubusercontent.com/gradle/gradle/v8.2.0/gradle/wrapper/gradle-wrapper.properties -o gradle/wrapper/gradle-wrapper.properties
```

### 2. GitHub Actions仍然失败

**解决方案**：查看构建日志

1. 打开失败的构建记录
2. 点击左侧的构建步骤
3. 查看每个步骤的详细日志
4. 找到具体的错误信息

### 3. 权限错误

**问题**：`chmod +x gradlew`失败

**解决方案**：确保gradlew文件存在且有执行权限

```bash
# 检查文件是否存在
ls -la gradlew

# 手动设置执行权限
chmod +x gradlew
```

## 替代方案

如果GitHub Actions仍然无法工作，可以使用其他在线打包平台：

### 1. 使用Android Studio本地构建

1. 打开Android Studio
2. 打开项目
3. 等待Gradle同步完成
4. 选择Build → Build Bundle(s) / APK(s) → Build APK(s)
5. 在`app/build/outputs/apk/`目录找到APK文件

### 2. 使用命令行构建

```bash
# 构建Debug版本
./gradlew assembleDebug

# 构建Release版本
./gradlew assembleRelease
```

### 3. 使用在线打包服务

- **AppVeyor**：https://www.appveyor.com/
- **CircleCI**：https://circleci.com/
- **Travis CI**：https://travis-ci.org/

## 总结

构建失败的主要原因：
1. ✅ `.gitignore`配置错误（已修复）
2. ✅ Gradle Wrapper文件缺失（需要生成）
3. ✅ GitHub Actions工作流文件缺失（需要创建）

修复后的改进：
1. ✅ 自动设置Gradle Wrapper
2. ✅ 更好的错误处理
3. ✅ 上传构建日志便于调试
4. ✅ 添加Gradle缓存提高构建速度

按照本指南的步骤操作，应该能够成功构建APK文件。